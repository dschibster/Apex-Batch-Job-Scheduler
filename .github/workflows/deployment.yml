name: Code Coverage and Release

on:
    workflow_dispatch:
    push:
        paths:
            - "batch-orchestrator/**"
    pull_request:
        branches:
            - master
        paths:
            - "batch-orchestrator/**"

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
              with:
                  ref: ${{ github.head_ref }}
            - name: "Install Salesforce CLI"
              run: |
                  wget https://developer.salesforce.com/media/salesforce-cli/sfdx/channels/stable/sfdx-linux-x64.tar.xz
                  mkdir ~/sfdx
                  tar xJf sfdx-linux-x64.tar.xz -C ~/sfdx --strip-components 1
                  echo "$HOME/sfdx/bin" >> $GITHUB_PATH
                  ~/sfdx/bin/sfdx version
            - name: Populate auth file
              run: 'echo "${{ secrets.SFDX_AUTH_URL }}" > ./SALESFORCE_AUTH_URL.txt'
            - name: Authenticate Dev Hub
              run: "sfdx force:auth:sfdxurl:store -f ./SALESFORCE_AUTH_URL.txt -a devhub -d"
            - name: Create Scratch Org
              run: sfdx force:org:create --targetdevhubusername devhub --setdefaultusername --definitionfile config/project-scratch-def.json --setalias ciorg --durationdays 1
            - name: Deploy source
              run: sfdx force:source:push
            - name: Run Apex tests
              run: sfdx force:apex:test:run --codecoverage --resultformat human -d ./
            - name: Delete Scratch Org
              run: sfdx force:org:delete --noprompt
            - name: Upload code coverage for Apex to Codecov.io
              uses: codecov/codecov-action@v1
              with:
                  flags: Apex
            - name: Create new Package version and Promote
              # Currently only to be run when creating a PR toward master, in any other case we don't want to go that route.
              # Can be adjusted in the future to only promote packages when merging, but create packages in a PR
              if: github.ref != 'refs/head/master' && github.actor == github.event.repository.owner.login
              run: |
                  chmod +x scripts/packagepromotion.sh
                  ./scripts/packagepromotion.sh
